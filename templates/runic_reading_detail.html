{% extends "base.html" %}

{% block title %}Runic Reading Detail - The Oracle{% endblock %}
{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-3">
    <ol class="breadcrumb breadcrumb-oracle">
        <li class="breadcrumb-item">
            <a href="{{ url_for('index') }}" class="text-white">
                <i class="bi bi-house"></i> Home
            </a>
        </li>
        <li class="breadcrumb-item active text-white" aria-current="page">
            <i class="bi bi-eye"></i> Runic Reading
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="p-4">
    <!-- Rune Cast -->
    <div class="card card-oracle mb-4 card-oracle-runes">
        <div class="card-body p-4">
            <h5 class="text-primary mb-3">
                <i class="bi bi-diamond"></i> Rune Cast
            </h5>

            <!-- Parse the runic reading from hexagram field -->
            {% set runic_data = reading_entry.hexagram %}
            {% if runic_data %}
                <!-- Extract runes from the reading string -->
                {% set rune_lines = runic_data.split('\n')[1:] %}
                {% set runes_info = [] %}
                {% for line in rune_lines %}
                    {% if line.strip() and ':' in line %}
                        {% set parts = line.split(':') %}
                        {% if parts|length >= 2 %}
                            {% set position = parts[0].strip() %}
                            {% set rune_part = parts[1].strip() %}
                            {% if rune_part %}
                                {% set is_reversed = '(Reversed)' in rune_part %}
                                {% set rune_part = rune_part.replace('(Reversed)', '').strip() %}
                                {% set rune_symbol = rune_part.split(' ')[0] %}
                                {% set rune_name_raw = rune_part.split(' ')[1] if rune_part.split(' ')|length > 1 else '' %}
                                {% set rune_name = rune_name_raw.replace('(Reversed)', '').strip() %}
                                {% set rune_meaning = parts[2][0:-1] if is_reversed else rune_part.split(' ', 2)[2] if rune_part.split(' ')|length > 2 else '' %}
                                {% set _ = runes_info.append({
                                    'position': position,
                                    'symbol': rune_symbol,
                                    'name': rune_name,
                                    'meaning': rune_meaning,
                                    'is_reversed': is_reversed
                                }) %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endfor %}

                <!-- Display runes in spread pattern -->
                {% set spread_name = runic_data.split(' - ')[1].split('\n')[0] if ' - ' in runic_data else 'Unknown' %}

                {% if spread_name == "Single" %}
                <!-- Single Rune Layout -->
                <div class="rune-spread-single">
                    {% for rune in runes_info %}
                    <div class="rune-item-spread">
                        <a href="{{ url_for('runes_list') }}#{{ rune.name.lower() }}" class="rune-link">
                            <div class="rune-symbol-spread{% if rune.is_reversed %} rune-reversed{% endif %}">
                                {{ rune.symbol }}
                            </div>
                            <div class="rune-name-spread">
                                {{ rune.name }}
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>

                {% elif spread_name == "Three Norns" %}
                <!-- Three Norns Layout: Past - Present - Future -->
                <div class="rune-spread-three-norns">
                    {% for rune in runes_info %}
                    <div class="rune-item-spread">
                        <a href="{{ url_for('runes_list') }}#{{ rune.name.lower() }}" class="rune-link">
                            <div class="rune-symbol-spread{% if rune.is_reversed %} rune-reversed{% endif %}">
                                {{ rune.symbol }}
                            </div>
                            <div class="rune-name-spread">
                                {{ rune.name }}
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>

                {% elif spread_name == "Five Cross" %}
                <!-- Five Rune Cross Layout:
                        4
                    2   1   3
                        5
                -->
                <div class="rune-spread-five-cross">
                    <div class="cross-row">
                        <div class="cross-position cross-top">
                            {% if runes_info|length >= 4 %}
                            <a href="{{ url_for('runes_list') }}#{{ runes_info[3].name.lower() }}" class="rune-link">
                                <div class="rune-symbol-spread{% if runes_info[3].is_reversed %} rune-reversed{% endif %}">
                                    {{ runes_info[3].symbol }}
                                </div>
                                <div class="rune-name-spread">
                                    {{ runes_info[3].name }}
                                </div>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="cross-row">
                        <div class="cross-position cross-left">
                            {% if runes_info|length >= 2 %}
                            <a href="{{ url_for('runes_list') }}#{{ runes_info[1].name.lower() }}" class="rune-link">
                                <div class="rune-symbol-spread{% if runes_info[1].is_reversed %} rune-reversed{% endif %}">
                                    {{ runes_info[1].symbol }}
                                </div>
                                <div class="rune-name-spread">
                                    {{ runes_info[1].name }}
                                </div>
                            </a>
                            {% endif %}
                        </div>
                        <div class="cross-position cross-center">
                            {% if runes_info|length >= 1 %}
                            <a href="{{ url_for('runes_list') }}#{{ runes_info[0].name.lower() }}" class="rune-link">
                                <div class="rune-symbol-spread{% if runes_info[0].is_reversed %} rune-reversed{% endif %}">
                                    {{ runes_info[0].symbol }}
                                </div>
                                <div class="rune-name-spread">
                                    {{ runes_info[0].name }}
                                </div>
                            </a>
                            {% endif %}
                        </div>
                        <div class="cross-position cross-right">
                            {% if runes_info|length >= 3 %}
                            <a href="{{ url_for('runes_list') }}#{{ runes_info[2].name.lower() }}" class="rune-link">
                                <div class="rune-symbol-spread{% if runes_info[2].is_reversed %} rune-reversed{% endif %}">
                                    {{ runes_info[2].symbol }}
                                </div>
                                <div class="rune-name-spread">
                                    {{ runes_info[2].name }}
                                </div>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="cross-row">
                        <div class="cross-position cross-bottom">
                            {% if runes_info|length >= 5 %}
                            <a href="{{ url_for('runes_list') }}#{{ runes_info[4].name.lower() }}" class="rune-link">
                                <div class="rune-symbol-spread{% if runes_info[4].is_reversed %} rune-reversed{% endif %}">
                                    {{ runes_info[4].symbol }}
                                </div>
                                <div class="rune-name-spread">
                                    {{ runes_info[4].name }}
                                </div>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% elif spread_name == "Seven Chakras" %}
                <!-- Seven Chakras Layout: Horizontal alignment -->
                <div class="rune-spread-seven-chakras">
                    {% for rune in runes_info %}
                    <div class="chakra-position">
                        <a href="{{ url_for('runes_list') }}#{{ rune.name.lower() }}" class="rune-link">
                            <div class="rune-symbol-spread{% if rune.is_reversed %} rune-reversed{% endif %}">
                                {{ rune.symbol }}
                            </div>
                            <div class="rune-name-spread">
                                {{ rune.name }}
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>

                {% else %}
                <!-- Fallback: Horizontal layout for unknown spreads -->
                <div class="runes-horizontal">
                    {% for rune in runes_info %}
                    <div class="rune-item">
                        <a href="{{ url_for('runes_list') }}#{{ rune.name.lower() }}" class="rune-link">
                            <div class="rune-symbol-large{% if rune.is_reversed %} rune-reversed{% endif %}">
                                {{ rune.symbol }}
                            </div>
                            <div class="rune-name">
                                {{ rune.name }}{% if rune.is_reversed %} <span class="reversed-indicator">(Reversed)</span>{% endif %}
                            </div>
                        </a>
                        <div class="rune-position">
                            {{ rune.position }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Display rune meanings -->
                <div class="runes-meanings mt-4">
                    {% for rune in runes_info %}
                    <div class="rune-meaning-card mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <span class="rune-symbol-small me-2{% if rune.is_reversed %} rune-reversed{% endif %}">{{ rune.symbol }}</span>
                            <strong class="rune-name-header">{{ rune.name }}{% if rune.is_reversed %} <span class="reversed-indicator">(Reversed)</span>{% endif %}</strong>
                        </div>
                        <div class="rune-meaning-text">
                            {%if rune.is_reversed %}<span class="reversed-indicator">(Reversed meaning)</span>{% endif %}{{ rune.meaning }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Reading Header -->
    <div class="card card-oracle mb-4">
        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, var(--oracle-primary) 0%, var(--oracle-secondary) 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-eye"></i> Your Runic Reading
                </h4>
                <small class="text-white-50">
                    <i class="bi bi-calendar3"></i>
                    {{ reading_entry.reading_dt[:10] if reading_entry.reading_dt else 'Unknown Date' }}
                </small>
            </div>
        </div>
        <div class="card-body">
            <!-- Question with Truncation -->
            <div class="mb-4">
                <h5 class="text-primary">
                    <i class="bi bi-question-circle"></i> Your Question
                </h5>
                <div class="question-container">
                    <div id="question-preview" class="question-preview">
                        <blockquote class="blockquote">
                            <div class="fs-5 mb-0 markdown-content">{{ reading_entry.question | markdown | safe }}</div>
                        </blockquote>
                    </div>
                    <div id="question-full" class="question-full" style="display: none;">
                        <blockquote class="blockquote">
                            <div class="fs-5 mb-0 markdown-content">{{ reading_entry.question | markdown | safe }}</div>
                        </blockquote>
                    </div>
                    <button id="question-toggle" class="btn btn-link p-0 text-primary" style="display: none;">
                        <small>Show more</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Reading -->
    <div class="card card-oracle mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-book-half"></i> Complete Reading
            </h5>
        </div>
        <div class="card-body reading-content">
            {{ enhanced_reading | safe }}
        </div>
    </div>

    <!-- Reading Metadata -->
    <div class="card card-oracle mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="bi bi-info-circle"></i> Reading Information
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2">
                        <strong><i class="bi bi-person"></i> Seeker:</strong> {{ reading_entry.username }}
                    </p>
                    <p class="mb-2">
                        <strong><i class="bi bi-calendar3"></i> Date:</strong>
                        {{ reading_entry.reading_dt[:19].replace('T', ' ') if reading_entry.reading_dt else 'Unknown' }}
                    </p>
                </div>
                <div class="col-md-6">
                    <p class="mb-2">
                        <strong><i class="bi bi-hash"></i> Reading ID:</strong>
                        <code>{{ reading_entry.reading_id }}</code>
                    </p>
                    <p class="mb-2">
                        <strong><i class="bi bi-link-45deg"></i> Shareable Path:</strong>
                        <code>/reading/{{ reading_entry.get_reading_path() }}</code>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="text-center">
        <a href="{{ url_for('index') }}" class="btn btn-oracle me-3">
            <i class="bi bi-arrow-left"></i> Back to Oracle
        </a>
        <a href="{{ url_for('runes_list') }}" class="btn btn-oracle">
            <i class="bi bi-diamond"></i> Explore Runes
        </a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Oracle-themed button overrides */
.btn-outline-primary {
    border-color: var(--oracle-gold-dark) !important;
    color: var(--oracle-gold-dark) !important;
    background: transparent !important;
}

.btn-outline-primary:hover {
    background: var(--oracle-gold) !important;
    border-color: var(--oracle-gold) !important;
    color: var(--oracle-black) !important;
}

/* Reading page specific enhancements */
.card-oracle-runes {
    background: linear-gradient(135deg, rgba(255,215,0,0.05) 0%, rgba(255,215,0,0.1) 100%);
}

/* Additional reading content enhancements */
.reading-content {
    font-size: 1.1rem;
    line-height: 1.8;
}

.reading-content p {
    margin-bottom: 1.2rem;
}

.reading-content h1, .reading-content h2, .reading-content h3 {
    margin-top: 2rem;
    margin-bottom: 1rem;
}

.reading-content blockquote {
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent);
}

/* Question truncation styles */
.question-preview .markdown-content {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    line-height: 1.5;
    max-height: 4.5em;
}

.question-container {
    position: relative;
}

.question-toggle-fade {
    background: linear-gradient(transparent, rgba(255,255,255,0.9));
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2rem;
    pointer-events: none;
}

/* Markdown content styling */
.markdown-content h1, .markdown-content h2, .markdown-content h3,
.markdown-content h4, .markdown-content h5, .markdown-content h6 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}

.markdown-content p {
    margin-bottom: 0.75rem;
}

.markdown-content blockquote {
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent);
}

.markdown-content ul, .markdown-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.markdown-content code {
    background: linear-gradient(135deg, var(--oracle-black) 0%, var(--oracle-black-light) 100%);
    color: var(--oracle-gold);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
    border: 1px solid var(--oracle-gold-dark);
}

.markdown-content pre {
    background: linear-gradient(135deg, var(--oracle-black) 0%, var(--oracle-black-light) 100%);
    color: var(--oracle-gold);
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    border: 2px solid var(--oracle-gold-dark);
}

/* Runic display styling */
.runes-horizontal {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    margin: 2rem 0;
    flex-wrap: wrap;
}

.rune-item {
    text-align: center;
    min-width: 120px;
}

.rune-link {
    text-decoration: none;
    color: inherit;
    display: block;
    transition: transform 0.2s ease;
}

.rune-link:hover {
    transform: scale(1.05);
    text-decoration: none;
    color: inherit;
}

.rune-symbol-large {
    font-size: 3.5rem;
    color: var(--oracle-gold);
    text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
    filter: drop-shadow(2px 2px 24px var(--oracle-gold-dark));
    margin-bottom: 0.5rem;
    transition: transform 0.3s ease;
}

.rune-symbol-large.rune-reversed {
    transform: rotate(180deg);
}

.rune-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--oracle-red);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    margin-bottom: 0.25rem;
}

.rune-position {
    font-size: 0.9rem;
    color: var(--oracle-red-dark);
    font-weight: 500;
    font-style: italic;
}

.runes-meanings {
    border-top: 2px solid var(--oracle-gold-dark);
    padding-top: 1rem;
}

.rune-meaning-card {
    background: linear-gradient(135deg, rgba(255,215,0,0.05) 0%, rgba(255,215,0,0.1) 100%);
    border: 1px solid var(--oracle-gold-dark);
    border-radius: 0.5rem;
    padding: 1rem;
}

.rune-symbol-small {
    font-size: 1.5rem;
    color: var(--oracle-gold);
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
    display: inline-block;
}

.rune-symbol-small.rune-reversed {
    transform: rotate(180deg);
}

.rune-name-header {
    color: var(--oracle-red);
    font-size: 1.1rem;
}

.rune-meaning-text {
    color: var(--oracle-text);
    font-size: 1rem;
    line-height: 1.5;
}

.reversed-indicator {
    color: var(--oracle-red-dark);
    font-size: 0.8rem;
    font-weight: 500;
    font-style: italic;
}

.rune-meaning-text .reversed-indicator {
    color: var(--oracle-black-light);
    font-size: 0.6rem;
    font-weight: 200;
    font-style: normal;
}

/* Spread-specific layouts */
.rune-symbol-spread {
    font-size: 3.5rem;
    color: var(--oracle-gold);
    text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
    filter: drop-shadow(2px 2px 24px var(--oracle-gold-dark));
    transition: transform 0.3s ease;
}

.rune-symbol-spread.rune-reversed {
    transform: rotate(180deg);
}

.rune-name-spread {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--oracle-red);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    margin-top: 0.5rem;
}

/* Single Rune Layout */
.rune-spread-single {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
}

/* Three Norns Layout */
.rune-spread-three-norns {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 3rem;
    margin: 2rem 0;
    flex-wrap: wrap;
}

/* Five Rune Cross Layout */
.rune-spread-five-cross {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 2rem 0;
    gap: 1rem;
}

.cross-row {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 3rem;
}

.cross-position {
    min-width: 80px;
    text-align: center;
}

.cross-top, .cross-bottom {
    width: 80px;
}

.cross-left, .cross-right, .cross-center {
    width: 80px;
}

/* Seven Chakras Layout */
.rune-spread-seven-chakras {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
    gap: 2rem;
    flex-wrap: wrap;
}

.chakra-position {
    text-align: center;
    min-width: 80px;
}

/* Toggle button styling */
#question-toggle {
    font-weight: bold;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .rune-spread-three-norns {
        gap: 2rem;
    }

    .cross-row {
        gap: 2rem;
    }

    .rune-spread-seven-chakras {
        gap: 1.5rem;
    }

    .rune-symbol-spread {
        font-size: 3rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionPreview = document.getElementById('question-preview');
    const questionFull = document.getElementById('question-full');
    const questionToggle = document.getElementById('question-toggle');

    // Check if question content is truncated
    const previewContent = questionPreview.querySelector('.markdown-content');
    const fullContent = questionFull.querySelector('.markdown-content');

    if (previewContent && fullContent) {
        // Clone the full content to measure its height
        const tempDiv = fullContent.cloneNode(true);
        tempDiv.style.position = 'absolute';
        tempDiv.style.visibility = 'hidden';
        tempDiv.style.height = 'auto';
        tempDiv.style.maxHeight = 'none';
        tempDiv.style.webkitLineClamp = 'none';
        tempDiv.style.display = 'block';
        document.body.appendChild(tempDiv);

        const fullHeight = tempDiv.scrollHeight;
        const previewHeight = previewContent.scrollHeight;

        document.body.removeChild(tempDiv);

        // If content is actually truncated, show the toggle button
        if (fullHeight > previewHeight || previewContent.scrollHeight > 72) { // 4.5em ≈ 72px
            questionToggle.style.display = 'block';

            let isExpanded = false;

            questionToggle.addEventListener('click', function() {
                if (!isExpanded) {
                    questionPreview.style.display = 'none';
                    questionFull.style.display = 'block';
                    questionToggle.innerHTML = '<small>Show less</small>';
                    isExpanded = true;
                } else {
                    questionPreview.style.display = 'block';
                    questionFull.style.display = 'none';
                    questionToggle.innerHTML = '<small>Show more</small>';
                    isExpanded = false;
                }
            });
        }
    }
});
</script>
{% endblock %}
